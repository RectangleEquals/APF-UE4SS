# Design09: Dependencies

> Full dependency tree, CMake configuration, and folder structures.

---

## APFrameworkCore Dependencies

> **IMPORTANT**: All apclientpp-related dependencies use specific commit hashes tested for compatibility. Do NOT update these independently - websocketpp and ASIO versions must be tested together!

```
APFrameworkCore
├── apclientpp (FetchContent - header-only)
│   ├── wswrap (FetchContent - header-only)
│   ├── asio (FetchContent - header-only)
│   └── websocketpp (FetchContent - header-only)
├── nlohmann::json (FetchContent - v3.12.0)
├── sol2 (header-only: third_party/sol2/sol.hpp)
├── lua-5.4.7 (static lib: third_party/lua-5.4.7/)
└── zlib (Release builds only - for compression)
```

### Dependency Details

| Dependency | Type | Version/Commit | Purpose |
|------------|------|----------------|---------|
| **apclientpp** | FetchContent | `main` branch | AP server communication (WebSocket client) |
| **wswrap** | FetchContent | `d0505e0ec53a26743f11051949a0dc66bcf44951` | WebSocket wrapper for apclientpp |
| **asio** | FetchContent | `f693a3eb7fe72a5f19b975289afc4f437d373d9c` | Async I/O for networking |
| **websocketpp** | FetchContent | `4dfe1be74e684acca19ac1cf96cce0df9eac2a2d` | WebSocket protocol implementation |
| **nlohmann::json** | FetchContent | `v3.12.0` | JSON parsing/serialization |
| **sol2** | Header-only | Manual copy | C++/Lua bindings |
| **lua-5.4.7** | Static lib | 5.4.7 | Lua interpreter |
| **zlib** | System/vcpkg | Latest | Compression (Release builds only) |

### Version Compatibility Note

The websocketpp and ASIO commit hashes are specifically tested together by the apclientpp maintainer. These commits are referenced in [apclientpp/test/CMakeLists.txt](https://github.com/black-sliver/apclientpp/blob/main/test/CMakeLists.txt). Do not update them independently or mixing incompatible versions may cause runtime crashes.

### Removed Dependencies

| Dependency | Reason |
|------------|--------|
| **valijson** | Removed via `AP_NO_SCHEMA` compile definition - unnecessary for our use case |

---

## APClientLib Dependencies

```
APClientLib
├── nlohmann::json (header-only: third_party/nlohmann/json.hpp)
├── sol2 (header-only: third_party/sol2/sol.hpp)
└── lua-5.4.7 (static lib: third_party/lua-5.4.7/)
```

APClientLib is intentionally lightweight — it doesn't need apclientpp since all AP communication goes through the framework.

---

## AP World Dependencies (Python)

```
worlds/apf/
├── BaseClasses (Archipelago core)
│   ├── World
│   ├── Item
│   ├── Location
│   ├── Region
│   └── MultiWorld
├── Options (Archipelago core)
│   └── TextChoice, Toggle, Range, etc.
└── Utils (Archipelago core)
    └── get_options
```

The AP World is a pure Python package that runs within Archipelago's generation context. It has no external dependencies beyond Archipelago's own libraries.

### AP World Purpose

The AP World bridges the framework's runtime capabilities with Archipelago's static generation process:

1. **Reads capabilities config** generated by APFrameworkCore at runtime
2. **Dynamically creates items/locations** based on what mods are installed
3. **Assigns IDs and classifications** during generation
4. **Communicates slot data** back to the framework via data packages

This is a critical component — without it, the framework cannot participate in Archipelago multiworlds.

---

## Folder Structures

### APFrameworkMod

```
APFrameworkMod/
├── Scripts/
│   ├── main.lua              # Entry point
│   ├── APFramework.lua       # Lua wrapper for APFrameworkCore
│   ├── APFrameworkCore.dll   # C++ framework core
│   ├── APClient.lua          # Lua wrapper for APClientLib (optional)
│   ├── APClientLib.dll       # C++ client library
│   ├── registry_helper.lua   # UE4SS hook utilities
│   ├── lunajson.lua          # JSON library for Lua
│   └── lunajson/             # lunajson module folder
│       ├── decoder.lua
│       ├── encoder.lua
│       └── sax.lua
├── framework_config.json     # Framework configuration
└── output/                   # Generated files
    └── AP_Capabilities_*.json
```

### AP Client Mods

```
<mod_name>/
├── Scripts/
│   ├── main.lua              # Mod entry point
│   ├── APClient.lua          # Lua wrapper for APClientLib
│   ├── APClientLib.dll       # C++ client library
│   ├── lunajson.lua          # JSON library for Lua
│   └── lunajson/             # lunajson module folder
│       ├── decoder.lua
│       ├── encoder.lua
│       └── sax.lua
└── manifest.json             # Mod manifest with capabilities
```

### Source Project Structure

```
ipc_2/
├── APFrameworkCore/
│   ├── include/
│   │   ├── APManager.h
│   │   ├── APClient.h
│   │   ├── APIPCServer.h
│   │   ├── APCapabilities.h
│   │   ├── APModRegistry.h
│   │   ├── APMessageRouter.h
│   │   ├── APStateManager.h
│   │   ├── APPollingThread.h
│   │   ├── APConfig.h
│   │   ├── APPathUtil.h
│   │   ├── APLogger.h
│   │   └── ap_types.h
│   ├── src/
│   │   ├── APClient.cpp
│   │   ├── APIPCServer.cpp
│   │   ├── APCapabilities.cpp
│   │   ├── APModRegistry.cpp
│   │   ├── APMessageRouter.cpp
│   │   ├── APStateManager.cpp
│   │   ├── APPollingThread.cpp
│   │   ├── APConfig.cpp
│   │   ├── APPathUtil.cpp
│   │   └── APLogger.cpp
├── APClientLib/
│   ├── include/
│   │   ├── APIPCClient.h
│   │   ├── APActionExecutor.h
│   │   ├── APPathUtil.h
│   │   └── APLogger.h
│   ├── src/
│   │   ├── APIPCClient.cpp
│   │   ├── APActionExecutor.cpp
│   │   ├── APPathUtil.cpp      # Shared with framework
│   │   └── APLogger.cpp        # Shared with framework
├── worlds/
│   └── apf/                    # AP World Python package
│       ├── __init__.py         # Main World class (APFWorld)
│       ├── items.py            # APFItem class and item helpers
│       ├── locations.py        # APFLocation class and location helpers
│       ├── options.py          # Player options (capabilities_file, etc.)
│       ├── regions.py          # Region creation helpers
│       └── rules.py            # Access rules (optional, for logic)
├── third_party/
│   ├── _deps/                  # CMake FetchContent downloads (gitignored)
│   │   ├── apclientpp-src/
│   │   ├── wswrap-src/
│   │   ├── websocketpp-src/
│   │   ├── asio-src/
│   │   └── json-src/
│   ├── sol2/
│   │   └── sol.hpp             # Manual copy
│   ├── lua-5.4.7/
│   │   ├── src/
│   │   └── CMakeLists.txt
│   └── lua/
│       ├── APFramework.lua
│       ├── APClient.lua
│       ├── registry_helper.lua
│       ├── lunajson.lua
│       └── lunajson/
├── Mods/
│   ├── APFrameworkMod/
│   │   ├── Scripts/
│   │   │   └── main.lua
│   │   └── framework_config.json
│   └── ExampleClientMod/
│       ├── Scripts/
│       │   └── main.lua
│       └── manifest.json
├── docs/
│   ├── Architecture/
│   │   ├── ARCHITECTURE.md
│   │   ├── Design01_SystemComponents.md
│   │   └── ...
│   └── .claude/
│       ├── Implementation/
│       │   ├── Implementation.md
│       │   ├── Phase01_ProjectSetup.md
│       │   └── ...
│       └── AP_DOCS/
├── tests/
│   ├── unit/
│   └── integration/
├── CMakeLists.txt
└── README.md
```

### AP World Package Structure

The `worlds/apf/` directory contains the Archipelago World package:

```
worlds/apf/
├── __init__.py         # APFWorld class - main World implementation
│                       # - generate_early(): Load capabilities config
│                       # - create_items(): Create items from capabilities
│                       # - create_regions(): Create regions and locations
│                       # - fill_slot_data(): Communicate data to framework
│                       # - get_filler_item_name(): Return filler item
│
├── items.py            # APFItem class extending Item
│                       # - item_name_to_id: Dict[str, int] (dynamic)
│                       # - item_table: Dict with item metadata
│
├── locations.py        # APFLocation class extending Location
│                       # - location_name_to_id: Dict[str, int] (dynamic)
│                       # - location_table: Dict with location metadata
│
├── options.py          # Player options
│                       # - CapabilitiesFile: TextChoice option
│                       # - Additional game-specific options
│
├── regions.py          # Region creation helpers
│                       # - create_regions(): Build region graph
│                       # - connect_regions(): Set up connections
│
└── rules.py            # Access rules (optional)
                        # - set_rules(): Define location access rules
                        # - For advanced logic requirements
```

**Key Implementation Notes:**

1. **Dynamic ID Mapping**: Unlike most AP Worlds, `item_name_to_id` and `location_name_to_id` are populated at runtime from the capabilities config, not statically defined.

2. **generate_early Hook**: The capabilities file is loaded during `generate_early()` before items/locations are created.

3. **Filler Handling**: Items with `amount: -1` in capabilities are treated as unlimited filler and created to balance the item pool.

4. **Slot Data**: The `fill_slot_data()` method communicates checksum and any ID remappings back to the framework.

---

## CMake Configuration

### Root CMakeLists.txt

```cmake
cmake_minimum_required(VERSION 3.20)
project(APFramework VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Options
option(BUILD_FRAMEWORK "Build APFrameworkCore" ON)
option(BUILD_CLIENTLIB "Build APClientLib" ON)
option(BUILD_TESTS "Build tests" OFF)

# =============================================================================
# Third-Party Dependencies via FetchContent
# =============================================================================
# IMPORTANT: These commit hashes are tested together by apclientpp maintainer.
# Do NOT update independently - see Version Compatibility Note above.
# =============================================================================

include(FetchContent)
set(FETCHCONTENT_QUIET OFF)

# apclientpp (header-only AP client library)
FetchContent_Declare(
    apclientpp
    GIT_REPOSITORY https://github.com/black-sliver/apclientpp.git
    GIT_TAG        main
)

# wswrap (WebSocket wrapper - specific tested commit)
FetchContent_Declare(
    wswrap
    GIT_REPOSITORY https://github.com/black-sliver/wswrap.git
    GIT_TAG        d0505e0ec53a26743f11051949a0dc66bcf44951
)

# websocketpp (specific tested commit - must match asio version)
FetchContent_Declare(
    websocketpp
    GIT_REPOSITORY https://github.com/zaphoyd/websocketpp.git
    GIT_TAG        4dfe1be74e684acca19ac1cf96cce0df9eac2a2d
)

# asio (specific tested commit - must match websocketpp version)
FetchContent_Declare(
    asio
    GIT_REPOSITORY https://github.com/chriskohlhoff/asio.git
    GIT_TAG        f693a3eb7fe72a5f19b975289afc4f437d373d9c
)

# nlohmann/json
FetchContent_Declare(
    json
    GIT_REPOSITORY https://github.com/nlohmann/json.git
    GIT_TAG        v3.12.0
)

FetchContent_MakeAvailable(apclientpp wswrap websocketpp asio json)

# =============================================================================
# apclientpp Interface Library (consolidates all apclientpp dependencies)
# =============================================================================

add_library(apclientpp_lib INTERFACE)

target_include_directories(apclientpp_lib INTERFACE
    ${apclientpp_SOURCE_DIR}
    ${wswrap_SOURCE_DIR}
    ${websocketpp_SOURCE_DIR}
    ${asio_SOURCE_DIR}/asio/include
)

target_compile_definitions(apclientpp_lib INTERFACE
    ASIO_STANDALONE
    _WEBSOCKETPP_CPP11_THREAD_
    AP_NO_SCHEMA          # Remove valijson dependency
    WSWRAP_NO_SSL         # No SSL support needed
)

# MSVC-specific flags
if(MSVC)
    target_compile_options(apclientpp_lib INTERFACE
        /Zc:__cplusplus   # Report correct __cplusplus value
        /bigobj           # Large object file support for templates
    )
endif()

# Compression: Disabled in Debug, Required in Release
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    target_compile_definitions(apclientpp_lib INTERFACE
        WSWRAP_NO_COMPRESSION
    )
    message(STATUS "APFramework: Compression DISABLED (Debug build)")
else()
    # Release builds require zlib for compression
    find_package(ZLIB REQUIRED)
    target_link_libraries(apclientpp_lib INTERFACE ZLIB::ZLIB)
    message(STATUS "APFramework: Compression ENABLED (Release build)")
endif()

# =============================================================================
# Other Dependencies
# =============================================================================

# Lua
add_subdirectory(third_party/lua-5.4.7)

# sol2 (header-only, manual copy)
add_library(sol2 INTERFACE)
target_include_directories(sol2 INTERFACE
    ${CMAKE_CURRENT_SOURCE_DIR}/third_party)

# =============================================================================
# Build Targets
# =============================================================================

if(BUILD_FRAMEWORK)
    add_subdirectory(APFrameworkCore)
endif()

if(BUILD_CLIENTLIB)
    add_subdirectory(APClientLib)
endif()

if(BUILD_TESTS)
    enable_testing()
    add_subdirectory(tests)
endif()
```

### Framework CMakeLists.txt

```cmake
# APFrameworkCore/CMakeLists.txt

add_library(APFrameworkCore SHARED
    src/APClient.cpp
    src/APIPCServer.cpp
    src/APCapabilities.cpp
    src/APModRegistry.cpp
    src/APMessageRouter.cpp
    src/APStateManager.cpp
    src/APPollingThread.cpp
    src/APConfig.cpp
    src/APPathUtil.cpp
    src/APLogger.cpp
)

target_include_directories(APFrameworkCore
    PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}/include
    PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/src
)

# Link apclientpp_lib interface library (brings all apclientpp deps and flags)
target_link_libraries(APFrameworkCore
    PRIVATE apclientpp_lib
    PRIVATE nlohmann_json::nlohmann_json
    PRIVATE sol2
    PRIVATE lua_static
)

if(WIN32)
    target_link_libraries(APFrameworkCore PRIVATE ws2_32)
endif()

target_compile_definitions(APFrameworkCore PRIVATE
    AP_FRAMEWORK_EXPORTS
)

# Export function for Lua loading
set_target_properties(APFrameworkCore PROPERTIES
    PREFIX ""
    OUTPUT_NAME "APFrameworkCore"
)

# Install
install(TARGETS APFrameworkCore
    RUNTIME DESTINATION bin
    LIBRARY DESTINATION lib
)
```

### ClientLib CMakeLists.txt

```cmake
# src/clientlib/CMakeLists.txt

add_library(APClientLib SHARED
    APIPCClient.cpp
    APActionExecutor.cpp
    APPathUtil.cpp
    APLogger.cpp
)

target_include_directories(APClientLib
    PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}
    PRIVATE ${CMAKE_SOURCE_DIR}/third_party
)

target_link_libraries(APClientLib
    PRIVATE nlohmann_json
    PRIVATE sol2
    PRIVATE lua_static
)

target_compile_definitions(APClientLib
    PRIVATE AP_CLIENTLIB_EXPORTS
)

# Export function for Lua loading
set_target_properties(APClientLib PROPERTIES
    PREFIX ""
    OUTPUT_NAME "APClientLib"
)

# Install
install(TARGETS APClientLib
    RUNTIME DESTINATION bin
    LIBRARY DESTINATION lib
)
```

### Lua CMakeLists.txt

```cmake
# third_party/lua-5.4.7/CMakeLists.txt

add_library(lua_static STATIC
    src/lapi.c
    src/lauxlib.c
    src/lbaselib.c
    src/lcode.c
    src/lcorolib.c
    src/lctype.c
    src/ldblib.c
    src/ldebug.c
    src/ldo.c
    src/ldump.c
    src/lfunc.c
    src/lgc.c
    src/linit.c
    src/liolib.c
    src/llex.c
    src/lmathlib.c
    src/lmem.c
    src/loadlib.c
    src/lobject.c
    src/lopcodes.c
    src/loslib.c
    src/lparser.c
    src/lstate.c
    src/lstring.c
    src/lstrlib.c
    src/ltable.c
    src/ltablib.c
    src/ltm.c
    src/lundump.c
    src/lutf8lib.c
    src/lvm.c
    src/lzio.c
)

target_include_directories(lua_static PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}/src)

if(WIN32)
    target_compile_definitions(lua_static PRIVATE LUA_BUILD_AS_DLL)
endif()
```

---

## DLL Export Configuration

### APFrameworkCore Export

```cpp
// ap_exports.h
#pragma once

#ifdef _WIN32
    #ifdef AP_FRAMEWORK_EXPORTS
        #define AP_API __declspec(dllexport)
    #else
        #define AP_API __declspec(dllimport)
    #endif
#else
    #define AP_API
#endif

// Lua entry point
extern "C" {
    AP_API int luaopen_APFrameworkCore(lua_State* L);
}
```

### APClientLib Export

```cpp
// ap_clientlib_exports.h
#pragma once

#ifdef _WIN32
    #ifdef AP_CLIENTLIB_EXPORTS
        #define APCLIENT_API __declspec(dllexport)
    #else
        #define APCLIENT_API __declspec(dllimport)
    #endif
#else
    #define APCLIENT_API
#endif

// Lua entry point
extern "C" {
    APCLIENT_API int luaopen_APClientLib(lua_State* L);
}
```

---

## Build Instructions

### Prerequisites

- CMake 3.20+
- Visual Studio 2019+ (Windows)
- Git (for FetchContent cloning)
- **Release builds only**: zlib (via vcpkg or system package)

### Clone Repository

```bash
git clone https://github.com/user/ap-framework.git
cd ap-framework
```

> **Note**: No `--recursive` needed! Dependencies are fetched automatically via CMake FetchContent.

### Install zlib (Release builds only)

Release builds require zlib for AP server compression support. Install via vcpkg:

```bash
# Install vcpkg if needed
git clone https://github.com/microsoft/vcpkg.git
cd vcpkg && bootstrap-vcpkg.bat && cd ..

# Install zlib
vcpkg install zlib:x64-windows
```

### Build Debug (no compression)

```bash
mkdir build-debug
cd build-debug
cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Debug
cmake --build . --config Debug
```

### Build Release (with compression)

```bash
mkdir build-release
cd build-release
cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=<vcpkg_root>/scripts/buildsystems/vcpkg.cmake
cmake --build . --config Release
```

### Output

After building:

```
build-release/
├── Release/
│   ├── APFrameworkCore.dll
│   └── APClientLib.dll
```

### First Build Note

The first build will take longer as CMake FetchContent downloads:
- apclientpp (~1MB)
- wswrap (~50KB)
- websocketpp (~5MB)
- asio (~10MB)
- nlohmann/json (~50MB)

These are cached in `build/_deps/` and won't re-download on subsequent builds.

### Deploy

Copy to UE4SS mod folders:

```bash
# Framework mod
cp Release/APFrameworkCore.dll <game>/Binaries/Win64/ue4ss/Mods/APFrameworkMod/Scripts/
cp Release/APClientLib.dll <game>/Binaries/Win64/ue4ss/Mods/APFrameworkMod/Scripts/

# Client mods
cp Release/APClientLib.dll <game>/Binaries/Win64/ue4ss/Mods/<mod_name>/Scripts/
```

---

## UE4SS Mod Types Note

| Type | Location | Description |
|------|----------|-------------|
| UE4SS C++ Mod | `ue4ss/Mods/<mod>/dlls/main.dll` | Built against UE4SS toolchain. **Avoided** - version compatibility issues. |
| UE4SS Lua Mod | `ue4ss/Mods/<mod>/Scripts/main.lua` | Can load C++ libraries via `require`. **Preferred approach.** |
| C++ Library | `*.dll` in Scripts folder | Normal DLL with Lua bindings via sol2. **Our approach.** |

The framework uses the C++ Library approach — DLLs with sol2 bindings loaded by Lua mods via `require()`.